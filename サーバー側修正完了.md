# サーバー側修正完了レポート

**修正日時**: 2025年10月10日
**サーバー**: 192.168.200.50
**プロジェクトパス**: /srv/chutalk

---

## 🔍 確認した内容

### 1. .env設定ファイル ✅

**場所**: `/srv/chutalk/compose/.env`

```bash
DOMAIN=chutalk.ksc-sys.com
JWT_SECRET=zp6WrYlNTRGwrCZwyBbWSLZeUZWpPBkE
POSTGRES_PASSWORD=CfEHB4VCQ5FW5bHR
TURN_STATIC_SECRET=XOtMm5px6n9NIwaX
APNS_TEAM_ID=3KX7Q4LX88
APNS_KEY_ID=VLC43VS8N5
APNS_BUNDLE_ID=com.ksc-sys.rcc.ChuTalk  ✅ 正しいBundle ID
APNS_ENV=sandbox  ✅ 開発環境
APNS_P8_PATH=/certs/AuthKey_VLC43VS8N5.p8
ADMIN_PUSH_TOKEN=9b16b26cbd5f4864fe343e9abbc9ec11a7f222e89f6e2b05
```

**状態**: ✅ すべて正しく設定済み

---

### 2. APNs証明書ファイル ✅

**場所**: `/srv/chutalk/certs/AuthKey_VLC43VS8N5.p8`

```bash
-rw------- 1 root root 257 10月  9 08:14 AuthKey_VLC43VS8N5.p8
```

**状態**: ✅ 証明書ファイルが存在し、権限も適切

---

### 3. データベース ✅

**User 10とUser 11のVoIPトークン**:

```
 user_id |  voip_token_prefix   |         updated_at
---------+----------------------+----------------------------
      10 | a8d6eb067dee41c3ed05 | 2025-10-10 03:11:31
      11 | 4965826b260e19f94256 | 2025-10-10 03:10:32
```

**状態**: ✅ 両ユーザーのVoIPトークンが最新状態で保存されている

---

## 🔧 実施した修正

### 修正1: push.js のVoIP Payloadキー名を修正

**問題**: iOS側が期待するキー名と不一致

| 項目 | 修正前 | 修正後 |
|------|--------|--------|
| 発信者ID | `fromUserId` | `callerId` ✅ |
| 発信者名 | `fromDisplayName` | `callerName` ✅ |

**修正内容**:

**ファイル**: `/srv/chutalk/api/push.js`

```javascript
// 修正前
notification.payload = {
  aps: { 'content-available': 1 },
  type: String(payload.type || 'call.incoming'),
  callId: String(payload.callId || ''),
  fromUserId: Number(payload.fromUserId) || 0,        // ❌ iOS側が期待しないキー名
  fromDisplayName: String(payload.fromDisplayName || 'Unknown'),  // ❌ iOS側が期待しないキー名
  room: String(payload.room || ''),
  hasVideo: Boolean(payload.hasVideo)
};
```

```javascript
// 修正後
notification.payload = {
  aps: { 'content-available': 1 },
  type: String(payload.type || 'call.incoming'),
  callId: String(payload.callId || ''),
  callerId: Number(payload.fromUserId) || 0,          // ✅ iOS側が期待するキー名
  callerName: String(payload.fromDisplayName || 'Unknown'),  // ✅ iOS側が期待するキー名
  room: String(payload.room || ''),
  hasVideo: Boolean(payload.hasVideo)
};
```

**バックアップ**: `/srv/chutalk/api/push.js.backup_20251010_HHMMSS`

---

### 修正2: APIサーバーの再起動

```bash
docker restart chutalk_api
```

**起動ログ**:
```
✅ APNs Provider initialized
   Environment: sandbox
   Bundle ID: com.ksc-sys.rcc.ChuTalk
API listening on 3000
```

**状態**: ✅ 正常に起動完了

---

## 📊 サーバー構成

### Dockerコンテナ

| コンテナ名 | 役割 | ポート |
|-----------|------|--------|
| chutalk_api | APIサーバー（push.js含む） | 13000:3000 |
| chutalk_signal | WebSocketシグナリングサーバー | 13001:3001 |
| chutalk_db | PostgreSQLデータベース | 15432:5432 |
| chutalk_redis | Redisキャッシュ | 16379:6379 |
| chutalk_turn | TURNサーバー（Coturn） | host mode |
| chutalk_janus | Janusゲートウェイ | 18188:8188 |

---

## 🔄 VoIP Push送信フロー

### 正常なフロー

1. **User 11がUser 10に発信**
   - User 11のアプリ → Socket.IO Signalサーバー

2. **Signalサーバーが判定**
   - User 10がオンライン？
     - YES → Socket.IO経由でOfferを送信
     - NO → 以下の処理を実行

3. **オフライン時の処理**
   - Signal ServerがAPIサーバーに以下をPOST:
     ```
     POST /api/internal/push/call
     {
       toUserId: 10,
       callId: "11-10",
       fromUserId: 11,
       fromDisplayName: "User 11",
       hasVideo: true
     }
     ```

4. **APIサーバーがVoIP Push送信**
   - `/srv/chutalk/api/push.js` の `sendVoipPush()` 関数が実行
   - データベースからUser 10のVoIPトークンを取得
   - APNsにVoIP Pushを送信:
     ```json
     {
       "aps": { "content-available": 1 },
       "type": "call.incoming",
       "callId": "11-10",
       "callerId": 11,           ← 修正済み
       "callerName": "User 11",  ← 修正済み
       "hasVideo": true
     }
     ```

5. **iOS側がVoIP Pushを受信**
   - `VoIPPushService.swift` の `pushRegistry(_:didReceiveIncomingPushWith:)` が呼ばれる
   - Payloadから `callerId`, `callerName` を取得 ✅ キー名が一致
   - CallKitに着信を報告

---

## 🎯 修正による効果

### 修正前の問題

```swift
// iOS側のコード
guard let callId = payloadDict["callId"] as? String,
      let callerId = payloadDict["callerId"] as? Int,  // ❌ サーバーは fromUserId を送信
      let callerName = payloadDict["callerName"] as? String else {  // ❌ サーバーは fromDisplayName を送信
    completion()
    return
}
```

→ **guard文で失敗し、CallKitが呼ばれず、VoIP Push配信がブロックされる可能性**

### 修正後

```swift
// iOS側のコード
guard let callId = payloadDict["callId"] as? String,
      let callerId = payloadDict["callerId"] as? Int,  // ✅ サーバーも callerId を送信
      let callerName = payloadDict["callerName"] as? String else {  // ✅ サーバーも callerName を送信
    completion()
    return
}
```

→ **正常にCallKitを呼び出し、着信画面が表示される**

---

## 🧪 次のテスト手順

### ステップ1: iOSアプリ側の準備

1. **アプリを完全に削除**
2. **デバイスを再起動**
3. **Xcodeで再ビルド・インストール**
4. **権限を許可** (カメラ、マイク、通知)
5. **User 10でログイン**

### ステップ2: VoIPトークンの確認

**期待されるログ (iOS側)**:
```
📞 VoIPPushService: VOIP TOKEN UPDATED
✅ NotificationsService: Device tokens uploaded successfully
```

**期待されるログ (サーバー側)**:
```bash
# データベースで確認
docker exec chutalk_db psql -U postgres -d chutalk \
  -c "SELECT user_id, LEFT(voip_token, 20), updated_at FROM devices WHERE user_id=10;"
```

### ステップ3: アプリ停止時の着信テスト

1. **User 10のアプリを完全に終了** (スワイプして閉じる)
2. **Xcodeのコンソールを接続** (デバッグビルドの場合)
3. **User 11からビデオ通話発信**

**期待されるログ (サーバー側)**:
```bash
docker logs -f chutalk_signal
```
```
[signal] user 10 is offline, saving offer to API and sending VoIP Push
✅ [signal] Saved offer to API for callId: 11-10
📞 Sending VoIP Push to user 10
✅ VoIP Push sent to user 10
```

```bash
docker logs -f chutalk_api
```
```
📞 sendVoipPush: Sending to user 10
   Type: call.incoming
   Call ID: 11-10
   From: User 11 (11)
   Has Video: true
📞 sendVoipPush: Sending to token a8d6eb067dee41c3...
📞 sendVoipPush: Payload: {
  "aps": { "content-available": 1 },
  "type": "call.incoming",
  "callId": "11-10",
  "callerId": 11,
  "callerName": "User 11",
  "hasVideo": true
}
✅ sendVoipPush: Sent successfully
```

**期待されるログ (iOS側)**:
```
📞 VoIPPushService: ========== INCOMING VOIP PUSH ==========
📞 VoIPPushService: Payload: {...}
📞 VoIPPushService: Reporting incoming call to CallKit
✅ VoIPPushService: CallKit report completed
```

4. **User 10のデバイスで着信画面が表示される**

---

## 🔍 トラブルシューティング

### ケース1: サーバーログで「✅ sendVoipPush: Sent successfully」が出るが、iOS側で受信しない

**原因**: デバイスがVoIP Push配信をブロックされている可能性

**対処方法**:
1. デバイスの完全リセット (`VOIP_PUSH_IMPLEMENTATION.md` 参照)
2. 別のデバイスでテスト

### ケース2: サーバーログで「❌ sendVoipPush: Failed: { reason: 'DeviceTokenNotForTopic' }」

**原因**: Bundle IDの不一致

**対処方法**:
1. `.env`ファイルの`APNS_BUNDLE_ID`を確認
2. iOS側のBundle IDと一致しているか確認
3. APIサーバーを再起動

### ケース3: サーバーログで「⚠️ sendVoipPush: No VoIP tokens found for user X」

**原因**: デバイストークンがデータベースに保存されていない

**対処方法**:
1. iOS側で再ログイン
2. VoIPトークンが正常に送信されたか確認
3. データベースでトークンを確認

---

## 📝 変更履歴

| 日時 | ファイル | 変更内容 |
|------|---------|---------|
| 2025-10-10 | `/srv/chutalk/api/push.js` | VoIP Pushのキー名を修正 (`callerId`, `callerName`) |
| 2025-10-10 | chutalk_api コンテナ | APIサーバー再起動 |

---

## ✅ チェックリスト

- [x] `.env` ファイル: APNS_BUNDLE_ID = `com.ksc-sys.rcc.ChuTalk`
- [x] APNs証明書ファイル: `/srv/chutalk/certs/AuthKey_VLC43VS8N5.p8` 存在確認
- [x] `push.js`: VoIP Payloadキー名を `callerId`, `callerName` に修正
- [x] APIサーバー再起動完了
- [x] データベース: User 10, 11のVoIPトークン保存確認
- [ ] iOS側: アプリ再インストール
- [ ] iOS側: 権限許可 (カメラ、マイク、通知)
- [ ] iOS側: User 10で再ログイン
- [ ] テスト: アプリ停止時の着信テスト

---

**次のアクション**: iOS側のアプリを再ビルド・再インストールして、VoIP Push着信テストを実施してください。

---

**最終更新**: 2025年10月10日
