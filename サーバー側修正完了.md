# ã‚µãƒ¼ãƒãƒ¼å´ä¿®æ­£å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ

**ä¿®æ­£æ—¥æ™‚**: 2025å¹´10æœˆ10æ—¥
**ã‚µãƒ¼ãƒãƒ¼**: 192.168.200.50
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‘ã‚¹**: /srv/chutalk

---

## ğŸ” ç¢ºèªã—ãŸå†…å®¹

### 1. .envè¨­å®šãƒ•ã‚¡ã‚¤ãƒ« âœ…

**å ´æ‰€**: `/srv/chutalk/compose/.env`

```bash
DOMAIN=chutalk.ksc-sys.com
JWT_SECRET=zp6WrYlNTRGwrCZwyBbWSLZeUZWpPBkE
POSTGRES_PASSWORD=CfEHB4VCQ5FW5bHR
TURN_STATIC_SECRET=XOtMm5px6n9NIwaX
APNS_TEAM_ID=3KX7Q4LX88
APNS_KEY_ID=VLC43VS8N5
APNS_BUNDLE_ID=com.ksc-sys.rcc.ChuTalk  âœ… æ­£ã—ã„Bundle ID
APNS_ENV=sandbox  âœ… é–‹ç™ºç’°å¢ƒ
APNS_P8_PATH=/certs/AuthKey_VLC43VS8N5.p8
ADMIN_PUSH_TOKEN=9b16b26cbd5f4864fe343e9abbc9ec11a7f222e89f6e2b05
```

**çŠ¶æ…‹**: âœ… ã™ã¹ã¦æ­£ã—ãè¨­å®šæ¸ˆã¿

---

### 2. APNsè¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ« âœ…

**å ´æ‰€**: `/srv/chutalk/certs/AuthKey_VLC43VS8N5.p8`

```bash
-rw------- 1 root root 257 10æœˆ  9 08:14 AuthKey_VLC43VS8N5.p8
```

**çŠ¶æ…‹**: âœ… è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã€æ¨©é™ã‚‚é©åˆ‡

---

### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ âœ…

**User 10ã¨User 11ã®VoIPãƒˆãƒ¼ã‚¯ãƒ³**:

```
 user_id |  voip_token_prefix   |         updated_at
---------+----------------------+----------------------------
      10 | a8d6eb067dee41c3ed05 | 2025-10-10 03:11:31
      11 | 4965826b260e19f94256 | 2025-10-10 03:10:32
```

**çŠ¶æ…‹**: âœ… ä¸¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®VoIPãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ€æ–°çŠ¶æ…‹ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹

---

## ğŸ”§ å®Ÿæ–½ã—ãŸä¿®æ­£

### ä¿®æ­£1: push.js ã®VoIP Payloadã‚­ãƒ¼åã‚’ä¿®æ­£

**å•é¡Œ**: iOSå´ãŒæœŸå¾…ã™ã‚‹ã‚­ãƒ¼åã¨ä¸ä¸€è‡´

| é …ç›® | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ |
|------|--------|--------|
| ç™ºä¿¡è€…ID | `fromUserId` | `callerId` âœ… |
| ç™ºä¿¡è€…å | `fromDisplayName` | `callerName` âœ… |

**ä¿®æ­£å†…å®¹**:

**ãƒ•ã‚¡ã‚¤ãƒ«**: `/srv/chutalk/api/push.js`

```javascript
// ä¿®æ­£å‰
notification.payload = {
  aps: { 'content-available': 1 },
  type: String(payload.type || 'call.incoming'),
  callId: String(payload.callId || ''),
  fromUserId: Number(payload.fromUserId) || 0,        // âŒ iOSå´ãŒæœŸå¾…ã—ãªã„ã‚­ãƒ¼å
  fromDisplayName: String(payload.fromDisplayName || 'Unknown'),  // âŒ iOSå´ãŒæœŸå¾…ã—ãªã„ã‚­ãƒ¼å
  room: String(payload.room || ''),
  hasVideo: Boolean(payload.hasVideo)
};
```

```javascript
// ä¿®æ­£å¾Œ
notification.payload = {
  aps: { 'content-available': 1 },
  type: String(payload.type || 'call.incoming'),
  callId: String(payload.callId || ''),
  callerId: Number(payload.fromUserId) || 0,          // âœ… iOSå´ãŒæœŸå¾…ã™ã‚‹ã‚­ãƒ¼å
  callerName: String(payload.fromDisplayName || 'Unknown'),  // âœ… iOSå´ãŒæœŸå¾…ã™ã‚‹ã‚­ãƒ¼å
  room: String(payload.room || ''),
  hasVideo: Boolean(payload.hasVideo)
};
```

**ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: `/srv/chutalk/api/push.js.backup_20251010_HHMMSS`

---

### ä¿®æ­£2: APIã‚µãƒ¼ãƒãƒ¼ã®å†èµ·å‹•

```bash
docker restart chutalk_api
```

**èµ·å‹•ãƒ­ã‚°**:
```
âœ… APNs Provider initialized
   Environment: sandbox
   Bundle ID: com.ksc-sys.rcc.ChuTalk
API listening on 3000
```

**çŠ¶æ…‹**: âœ… æ­£å¸¸ã«èµ·å‹•å®Œäº†

---

## ğŸ“Š ã‚µãƒ¼ãƒãƒ¼æ§‹æˆ

### Dockerã‚³ãƒ³ãƒ†ãƒŠ

| ã‚³ãƒ³ãƒ†ãƒŠå | å½¹å‰² | ãƒãƒ¼ãƒˆ |
|-----------|------|--------|
| chutalk_api | APIã‚µãƒ¼ãƒãƒ¼ï¼ˆpush.jså«ã‚€ï¼‰ | 13000:3000 |
| chutalk_signal | WebSocketã‚·ã‚°ãƒŠãƒªãƒ³ã‚°ã‚µãƒ¼ãƒãƒ¼ | 13001:3001 |
| chutalk_db | PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | 15432:5432 |
| chutalk_redis | Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥ | 16379:6379 |
| chutalk_turn | TURNã‚µãƒ¼ãƒãƒ¼ï¼ˆCoturnï¼‰ | host mode |
| chutalk_janus | Janusã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ | 18188:8188 |

---

## ğŸ”„ VoIP Pushé€ä¿¡ãƒ•ãƒ­ãƒ¼

### æ­£å¸¸ãªãƒ•ãƒ­ãƒ¼

1. **User 11ãŒUser 10ã«ç™ºä¿¡**
   - User 11ã®ã‚¢ãƒ—ãƒª â†’ Socket.IO Signalã‚µãƒ¼ãƒãƒ¼

2. **Signalã‚µãƒ¼ãƒãƒ¼ãŒåˆ¤å®š**
   - User 10ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼Ÿ
     - YES â†’ Socket.IOçµŒç”±ã§Offerã‚’é€ä¿¡
     - NO â†’ ä»¥ä¸‹ã®å‡¦ç†ã‚’å®Ÿè¡Œ

3. **ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ™‚ã®å‡¦ç†**
   - Signal ServerãŒAPIã‚µãƒ¼ãƒãƒ¼ã«ä»¥ä¸‹ã‚’POST:
     ```
     POST /api/internal/push/call
     {
       toUserId: 10,
       callId: "11-10",
       fromUserId: 11,
       fromDisplayName: "User 11",
       hasVideo: true
     }
     ```

4. **APIã‚µãƒ¼ãƒãƒ¼ãŒVoIP Pushé€ä¿¡**
   - `/srv/chutalk/api/push.js` ã® `sendVoipPush()` é–¢æ•°ãŒå®Ÿè¡Œ
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰User 10ã®VoIPãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
   - APNsã«VoIP Pushã‚’é€ä¿¡:
     ```json
     {
       "aps": { "content-available": 1 },
       "type": "call.incoming",
       "callId": "11-10",
       "callerId": 11,           â† ä¿®æ­£æ¸ˆã¿
       "callerName": "User 11",  â† ä¿®æ­£æ¸ˆã¿
       "hasVideo": true
     }
     ```

5. **iOSå´ãŒVoIP Pushã‚’å—ä¿¡**
   - `VoIPPushService.swift` ã® `pushRegistry(_:didReceiveIncomingPushWith:)` ãŒå‘¼ã°ã‚Œã‚‹
   - Payloadã‹ã‚‰ `callerId`, `callerName` ã‚’å–å¾— âœ… ã‚­ãƒ¼åãŒä¸€è‡´
   - CallKitã«ç€ä¿¡ã‚’å ±å‘Š

---

## ğŸ¯ ä¿®æ­£ã«ã‚ˆã‚‹åŠ¹æœ

### ä¿®æ­£å‰ã®å•é¡Œ

```swift
// iOSå´ã®ã‚³ãƒ¼ãƒ‰
guard let callId = payloadDict["callId"] as? String,
      let callerId = payloadDict["callerId"] as? Int,  // âŒ ã‚µãƒ¼ãƒãƒ¼ã¯ fromUserId ã‚’é€ä¿¡
      let callerName = payloadDict["callerName"] as? String else {  // âŒ ã‚µãƒ¼ãƒãƒ¼ã¯ fromDisplayName ã‚’é€ä¿¡
    completion()
    return
}
```

â†’ **guardæ–‡ã§å¤±æ•—ã—ã€CallKitãŒå‘¼ã°ã‚Œãšã€VoIP Pushé…ä¿¡ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å¯èƒ½æ€§**

### ä¿®æ­£å¾Œ

```swift
// iOSå´ã®ã‚³ãƒ¼ãƒ‰
guard let callId = payloadDict["callId"] as? String,
      let callerId = payloadDict["callerId"] as? Int,  // âœ… ã‚µãƒ¼ãƒãƒ¼ã‚‚ callerId ã‚’é€ä¿¡
      let callerName = payloadDict["callerName"] as? String else {  // âœ… ã‚µãƒ¼ãƒãƒ¼ã‚‚ callerName ã‚’é€ä¿¡
    completion()
    return
}
```

â†’ **æ­£å¸¸ã«CallKitã‚’å‘¼ã³å‡ºã—ã€ç€ä¿¡ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹**

---

## ğŸ§ª æ¬¡ã®ãƒ†ã‚¹ãƒˆæ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: iOSã‚¢ãƒ—ãƒªå´ã®æº–å‚™

1. **ã‚¢ãƒ—ãƒªã‚’å®Œå…¨ã«å‰Šé™¤**
2. **ãƒ‡ãƒã‚¤ã‚¹ã‚’å†èµ·å‹•**
3. **Xcodeã§å†ãƒ“ãƒ«ãƒ‰ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
4. **æ¨©é™ã‚’è¨±å¯** (ã‚«ãƒ¡ãƒ©ã€ãƒã‚¤ã‚¯ã€é€šçŸ¥)
5. **User 10ã§ãƒ­ã‚°ã‚¤ãƒ³**

### ã‚¹ãƒ†ãƒƒãƒ—2: VoIPãƒˆãƒ¼ã‚¯ãƒ³ã®ç¢ºèª

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚° (iOSå´)**:
```
ğŸ“ VoIPPushService: VOIP TOKEN UPDATED
âœ… NotificationsService: Device tokens uploaded successfully
```

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚° (ã‚µãƒ¼ãƒãƒ¼å´)**:
```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ç¢ºèª
docker exec chutalk_db psql -U postgres -d chutalk \
  -c "SELECT user_id, LEFT(voip_token, 20), updated_at FROM devices WHERE user_id=10;"
```

### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¢ãƒ—ãƒªåœæ­¢æ™‚ã®ç€ä¿¡ãƒ†ã‚¹ãƒˆ

1. **User 10ã®ã‚¢ãƒ—ãƒªã‚’å®Œå…¨ã«çµ‚äº†** (ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦é–‰ã˜ã‚‹)
2. **Xcodeã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’æ¥ç¶š** (ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã®å ´åˆ)
3. **User 11ã‹ã‚‰ãƒ“ãƒ‡ã‚ªé€šè©±ç™ºä¿¡**

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚° (ã‚µãƒ¼ãƒãƒ¼å´)**:
```bash
docker logs -f chutalk_signal
```
```
[signal] user 10 is offline, saving offer to API and sending VoIP Push
âœ… [signal] Saved offer to API for callId: 11-10
ğŸ“ Sending VoIP Push to user 10
âœ… VoIP Push sent to user 10
```

```bash
docker logs -f chutalk_api
```
```
ğŸ“ sendVoipPush: Sending to user 10
   Type: call.incoming
   Call ID: 11-10
   From: User 11 (11)
   Has Video: true
ğŸ“ sendVoipPush: Sending to token a8d6eb067dee41c3...
ğŸ“ sendVoipPush: Payload: {
  "aps": { "content-available": 1 },
  "type": "call.incoming",
  "callId": "11-10",
  "callerId": 11,
  "callerName": "User 11",
  "hasVideo": true
}
âœ… sendVoipPush: Sent successfully
```

**æœŸå¾…ã•ã‚Œã‚‹ãƒ­ã‚° (iOSå´)**:
```
ğŸ“ VoIPPushService: ========== INCOMING VOIP PUSH ==========
ğŸ“ VoIPPushService: Payload: {...}
ğŸ“ VoIPPushService: Reporting incoming call to CallKit
âœ… VoIPPushService: CallKit report completed
```

4. **User 10ã®ãƒ‡ãƒã‚¤ã‚¹ã§ç€ä¿¡ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹**

---

## ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚±ãƒ¼ã‚¹1: ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ã€Œâœ… sendVoipPush: Sent successfullyã€ãŒå‡ºã‚‹ãŒã€iOSå´ã§å—ä¿¡ã—ãªã„

**åŸå› **: ãƒ‡ãƒã‚¤ã‚¹ãŒVoIP Pushé…ä¿¡ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§

**å¯¾å‡¦æ–¹æ³•**:
1. ãƒ‡ãƒã‚¤ã‚¹ã®å®Œå…¨ãƒªã‚»ãƒƒãƒˆ (`VOIP_PUSH_IMPLEMENTATION.md` å‚ç…§)
2. åˆ¥ã®ãƒ‡ãƒã‚¤ã‚¹ã§ãƒ†ã‚¹ãƒˆ

### ã‚±ãƒ¼ã‚¹2: ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ã€ŒâŒ sendVoipPush: Failed: { reason: 'DeviceTokenNotForTopic' }ã€

**åŸå› **: Bundle IDã®ä¸ä¸€è‡´

**å¯¾å‡¦æ–¹æ³•**:
1. `.env`ãƒ•ã‚¡ã‚¤ãƒ«ã®`APNS_BUNDLE_ID`ã‚’ç¢ºèª
2. iOSå´ã®Bundle IDã¨ä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª
3. APIã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•

### ã‚±ãƒ¼ã‚¹3: ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã§ã€Œâš ï¸ sendVoipPush: No VoIP tokens found for user Xã€

**åŸå› **: ãƒ‡ãƒã‚¤ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„

**å¯¾å‡¦æ–¹æ³•**:
1. iOSå´ã§å†ãƒ­ã‚°ã‚¤ãƒ³
2. VoIPãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£å¸¸ã«é€ä¿¡ã•ã‚ŒãŸã‹ç¢ºèª
3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèª

---

## ğŸ“ å¤‰æ›´å±¥æ­´

| æ—¥æ™‚ | ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ |
|------|---------|---------|
| 2025-10-10 | `/srv/chutalk/api/push.js` | VoIP Pushã®ã‚­ãƒ¼åã‚’ä¿®æ­£ (`callerId`, `callerName`) |
| 2025-10-10 | chutalk_api ã‚³ãƒ³ãƒ†ãƒŠ | APIã‚µãƒ¼ãƒãƒ¼å†èµ·å‹• |

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] `.env` ãƒ•ã‚¡ã‚¤ãƒ«: APNS_BUNDLE_ID = `com.ksc-sys.rcc.ChuTalk`
- [x] APNsè¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«: `/srv/chutalk/certs/AuthKey_VLC43VS8N5.p8` å­˜åœ¨ç¢ºèª
- [x] `push.js`: VoIP Payloadã‚­ãƒ¼åã‚’ `callerId`, `callerName` ã«ä¿®æ­£
- [x] APIã‚µãƒ¼ãƒãƒ¼å†èµ·å‹•å®Œäº†
- [x] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: User 10, 11ã®VoIPãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ç¢ºèª
- [ ] iOSå´: ã‚¢ãƒ—ãƒªå†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [ ] iOSå´: æ¨©é™è¨±å¯ (ã‚«ãƒ¡ãƒ©ã€ãƒã‚¤ã‚¯ã€é€šçŸ¥)
- [ ] iOSå´: User 10ã§å†ãƒ­ã‚°ã‚¤ãƒ³
- [ ] ãƒ†ã‚¹ãƒˆ: ã‚¢ãƒ—ãƒªåœæ­¢æ™‚ã®ç€ä¿¡ãƒ†ã‚¹ãƒˆ

---

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: iOSå´ã®ã‚¢ãƒ—ãƒªã‚’å†ãƒ“ãƒ«ãƒ‰ãƒ»å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€VoIP Pushç€ä¿¡ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ10æ—¥
