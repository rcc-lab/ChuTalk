# リアルタイム通知テスト手順

**作成日時**: 2025年10月9日 23:00

---

## 前提条件

- ✅ iOSの通知設定: バナー、サウンド、バッジがすべてON
- ❌ それでもバナーが表示されない

→ 実際のログを確認して原因を特定します

---

## テスト手順

### ステップ1: アプリ起動時のログを確認

**目的**: 通知権限とAPNsトークンの登録状況を確認

**手順**:
1. Xcodeでアプリをビルド・起動（ユーザー10のデバイス）
2. アプリ起動直後のコンソールログをコピー
3. 以下のログが表示されているか確認

**確認するログ**:
```
📱 NotificationsService: Authorization status: ?
   Alert: ?
   Badge: ?
   Sound: ?

✅ AppDelegate: didRegisterForRemoteNotificationsWithDeviceToken
✅ NotificationsService: APNs token: [トークン]
✅ NotificationsService: Device tokens uploaded successfully

✅ VoIPPushService: VoIP Token: [トークン]
```

**ここにログを貼り付けてください**:
```
[ログをここに貼り付け]
```

---

### ステップ2: メッセージ送信テスト（アプリ停止時）

**目的**: サーバーからAPNs通知が送信されているか確認

**手順**:

#### 2-1: サーバーログ監視を開始

サーバーでログを監視します：
```bash
ssh takaoka@192.168.200.50

# ターミナル1: Signal Serverのログ
docker logs -f chutalk_signal 2>&1 | grep -A 5 "message\|offline"

# ターミナル2: API Serverのログ
docker logs -f chutalk_api 2>&1 | grep -A 10 "sendMessagePush\|sendVoipPush"
```

#### 2-2: テスト実行

1. ユーザー10のアプリを**完全に停止**（タスクマネージャーからスワイプアップ）
2. **30秒待つ**
3. ユーザー11からユーザー10にメッセージ「テストメッセージ」を送信
4. サーバーログを確認
5. ユーザー10のデバイスで通知が表示されるか確認

**期待されるサーバーログ（Signal Server）**:
```
[signal] user 10 is offline, sending message push
📨 Sending message Push to user 10
✅ Message Push sent to user 10
```

**期待されるサーバーログ（API Server）**:
```
📤 sendMessagePush: Sending to user 10
   Title: [ユーザー11の表示名]
   Body: テストメッセージ
📤 sendMessagePush: Sending to token [トークンの最初の16文字]...
✅ sendMessagePush: Sent successfully
```

**実際のサーバーログをここに貼り付けてください**:

**Signal Serverログ**:
```
[ログをここに貼り付け]
```

**API Serverログ**:
```
[ログをここに貼り付け]
```

**ユーザー10のデバイスで表示された内容**:
- [ ] バナーが表示された
- [ ] 音が鳴った
- [ ] バイブが振動した
- [ ] 何も表示されなかった

---

### ステップ3: メッセージ送信テスト（バックグラウンド時）

**目的**: バックグラウンド状態での通知受信を確認

**手順**:

1. ユーザー10でアプリを起動
2. ホームボタン（またはスワイプアップ）でバックグラウンドに移動（**アプリは終了しない**）
3. **10秒待つ**
4. ユーザー11からメッセージ「テスト2」を送信
5. ユーザー10のデバイスで通知が表示されるか確認

**ユーザー10のデバイスで表示された内容**:
- [ ] バナーが表示された
- [ ] 音が鳴った
- [ ] バイブが振動した
- [ ] 何も表示されなかった

---

### ステップ4: APNsトークン確認

**目的**: サーバーにAPNsトークンが正しく登録されているか確認

**手順**:
```bash
ssh takaoka@192.168.200.50
docker exec chutalk_db psql -U postgres -d chutalk -c \
  "SELECT user_id,
          CASE WHEN apns_token IS NOT NULL THEN LEFT(apns_token, 20) ELSE 'NULL' END as apns,
          CASE WHEN voip_token IS NOT NULL THEN LEFT(voip_token, 20) ELSE 'NULL' END as voip,
          bundle_id
   FROM devices
   WHERE user_id IN (10, 11);"
```

**実際のクエリ結果をここに貼り付けてください**:
```
[クエリ結果をここに貼り付け]
```

---

### ステップ5: iPhoneのフォーカスモード確認

**目的**: フォーカスモードや集中モードが通知をブロックしていないか確認

**確認項目**:

1. **コントロールセンターを開く**（画面右上から下にスワイプ）
2. **フォーカスモード**のアイコンが有効になっていないか確認
   - 三日月マーク（おやすみモード）
   - 仕事
   - 睡眠
   - など

**フォーカスモードが有効になっていますか？**:
- [ ] はい、有効になっている → 無効にしてください
- [ ] いいえ、無効になっている

---

### ステップ6: 通知履歴の確認

**目的**: 通知が届いているが表示されていないだけか確認

**手順**:
1. iPhoneの**ロック画面を表示**
2. **上にスワイプ**して通知センターを開く
3. ChuTalkからの通知が表示されているか確認

**通知センターに表示されていますか？**:
- [ ] はい、通知センターには表示されている（バナーだけが表示されない）
- [ ] いいえ、通知センター�にも表示されていない

---

## 診断フローチャート

```
ステップ1: Authorization status が 2 か？
    ↓ NO → 通知権限の問題
    ↓ YES
ステップ2: サーバーログで「Sent successfully」が表示されるか？
    ↓ NO → サーバー側の問題（トークン登録、APNs送信）
    ↓ YES
ステップ5: フォーカスモードが有効か？
    ↓ YES → フォーカスモードを無効にする
    ↓ NO
ステップ6: 通知センターに表示されているか？
    ↓ YES → バナー表示だけの問題（iOSの設定）
    ↓ NO → 通知が届いていない
```

---

## よくある原因

### 原因1: APNsトークンが登録されていない

**症状**: サーバーログで「No APNs tokens found for user X」が表示される

**対処法**:
1. アプリを完全に停止
2. アプリを再起動
3. アプリ起動時のログで「Device tokens uploaded successfully」が表示されるか確認

---

### 原因2: フォーカスモードが有効

**症状**: 音もバイブも来ない

**対処法**:
1. コントロールセンターを開く
2. フォーカスモードを無効にする

---

### 原因3: バックグラウンドApp更新がオフ

**症状**: アプリ停止時に通知が来ない

**対処法**:
```
設定 → ChuTalk → バックグラウンドApp更新: ON
```

---

### 原因4: APNs送信エラー

**症状**: サーバーログで「Failed:」が表示される

**対処法**:
サーバーログのエラーメッセージを確認して報告してください。

---

## 次のアクション

以下の情報を収集して報告してください：

1. **ステップ1のログ**（アプリ起動時）
2. **ステップ2のログ**（サーバーログ × 2）
3. **ステップ2の結果**（バナー表示されたか？）
4. **ステップ3の結果**（バックグラウンド時）
5. **ステップ4のクエリ結果**（APNsトークン）
6. **ステップ5の確認**（フォーカスモード）
7. **ステップ6の確認**（通知センター）

これらの情報があれば、問題の原因を特定できます。

---

**最終更新**: 2025年10月9日 23:00
