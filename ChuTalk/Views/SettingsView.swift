//
//  SettingsView.swift
//  ChuTalk
//
//  Created by Claude Code
//

import SwiftUI

struct SettingsView: View {
    @ObservedObject private var authService = AuthService.shared
    @AppStorage(Constants.UserDefaultsKeys.isVideoEnabledByDefault) private var isVideoEnabledByDefault = true
    @State private var showLogoutConfirmation = false
    @State private var showShareSheet = false
    @State private var logFileURL: URL?
    @State private var showLogAlert = false
    @State private var logAlertMessage = ""
    @State private var showImagePicker = false
    @State private var selectedImage: UIImage?
    @State private var profileImage: UIImage?

    var body: some View {
        NavigationView {
            List {
                // User Info Section
                Section {
                    if let user = authService.currentUser {
                        HStack(spacing: 16) {
                            Button(action: { showImagePicker = true }) {
                                ZStack(alignment: .bottomTrailing) {
                                    if let profileImage = profileImage {
                                        Image(uiImage: profileImage)
                                            .resizable()
                                            .scaledToFill()
                                            .frame(width: 60, height: 60)
                                            .clipShape(Circle())
                                    } else {
                                        Circle()
                                            .fill(Color.blue.opacity(0.2))
                                            .frame(width: 60, height: 60)
                                            .overlay(
                                                Text(String(user.displayName.prefix(1)))
                                                    .font(.title)
                                                    .foregroundColor(.blue)
                                            )
                                    }

                                    Circle()
                                        .fill(Color.blue)
                                        .frame(width: 20, height: 20)
                                        .overlay(
                                            Image(systemName: "camera.fill")
                                                .font(.system(size: 10))
                                                .foregroundColor(.white)
                                        )
                                }
                            }
                            .buttonStyle(.plain)

                            VStack(alignment: .leading, spacing: 4) {
                                Text(user.displayName)
                                    .font(.headline)

                                Text("@\(user.username)")
                                    .font(.subheadline)
                                    .foregroundColor(.secondary)

                                Text("„Çø„ÉÉ„Éó„Åó„Å¶ÁîªÂÉè„ÇíÂ§âÊõ¥")
                                    .font(.caption)
                                    .foregroundColor(.blue)
                            }
                        }
                        .padding(.vertical, 8)
                    }
                }

                // Call Settings
                Section("ÈÄöË©±Ë®≠ÂÆö") {
                    Toggle("„Éá„Éï„Ç©„É´„Éà„Åß„Éì„Éá„Ç™„ÇíÊúâÂäπ„Å´„Åô„Çã", isOn: $isVideoEnabledByDefault)
                }

                // Future Features (Placeholder)
                Section("Â∞ÜÊù•„ÅÆÊ©üËÉΩ") {
                    HStack {
                        Image(systemName: "waveform")
                            .foregroundColor(.gray)
                        Text("ÈÄöË©±Èå≤Èü≥")
                        Spacer()
                        Text("ËøëÊó•ÂÖ¨Èñã")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }

                    HStack {
                        Image(systemName: "text.bubble")
                            .foregroundColor(.gray)
                        Text("ÊñáÂ≠óËµ∑„Åì„Åó")
                        Spacer()
                        Text("ËøëÊó•ÂÖ¨Èñã")
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }

                // Debug Section
                Section("„Éá„Éê„ÉÉ„Ç∞") {
                    Button(action: exportLogs) {
                        HStack {
                            Image(systemName: "doc.text")
                                .foregroundColor(.blue)
                            Text("„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà")
                            Spacer()
                            Image(systemName: "square.and.arrow.up")
                                .foregroundColor(.blue)
                        }
                    }

                    Button(action: clearLogs) {
                        HStack {
                            Image(systemName: "trash")
                                .foregroundColor(.red)
                            Text("„Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞„Çí„ÇØ„É™„Ç¢")
                        }
                    }
                }

                // About Section
                Section("„Ç¢„Éó„É™„Å´„Å§„ÅÑ„Å¶") {
                    HStack {
                        Text("„Éê„Éº„Ç∏„Éß„É≥")
                        Spacer()
                        Text("1.0.0")
                            .foregroundColor(.secondary)
                    }

                    HStack {
                        Text("„Çµ„Éº„Éê„Éº")
                        Spacer()
                        Text(Constants.Server.baseURL)
                            .font(.caption)
                            .foregroundColor(.secondary)
                            .lineLimit(1)
                    }
                }

                // Logout Section
                Section {
                    Button(action: { showLogoutConfirmation = true }) {
                        HStack {
                            Spacer()
                            Text("„É≠„Ç∞„Ç¢„Ç¶„Éà")
                                .foregroundColor(.red)
                                .fontWeight(.semibold)
                            Spacer()
                        }
                    }
                }
            }
            .navigationTitle("Ë®≠ÂÆö")
            .confirmationDialog("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„Åã?", isPresented: $showLogoutConfirmation, titleVisibility: .visible) {
                Button("„É≠„Ç∞„Ç¢„Ç¶„Éà", role: .destructive) {
                    authService.logout()
                }
                Button("„Ç≠„É£„É≥„Çª„É´", role: .cancel) {}
            }
            .sheet(isPresented: $showShareSheet) {
                if let url = logFileURL {
                    ActivityViewController(activityItems: [url])
                }
            }
            .alert("„É≠„Ç∞ÊÉÖÂ†±", isPresented: $showLogAlert) {
                Button("OK", role: .cancel) {}
            } message: {
                Text(logAlertMessage)
            }
            .sheet(isPresented: $showImagePicker) {
                ProfileImagePicker(selectedImage: $profileImage)
            }
            .onAppear {
                loadProfileImage()
            }
            .onChange(of: profileImage) { newImage in
                if let image = newImage {
                    saveProfileImage(image)
                }
            }
        }
        .navigationViewStyle(StackNavigationViewStyle()) // iPad„Åß„ÇÇ„Çπ„Çø„ÉÉ„ÇØ„Çπ„Çø„Ç§„É´„Çí‰ΩøÁî®
    }

    private func exportLogs() {
        // „Åæ„Åö„ÉÜ„Çπ„Éà„É≠„Ç∞„ÇíÊõ∏„ÅçËæº„ÇÄ
        FileLogger.shared.log("Export logs button tapped", category: "SettingsView")

        if let url = FileLogger.shared.getLogFileURL() {
            // „Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åô„Çã„ÅãÁ¢∫Ë™ç
            if FileManager.default.fileExists(atPath: url.path) {
                if let contents = try? String(contentsOf: url, encoding: .utf8) {
                    if contents.isEmpty {
                        logAlertMessage = "„É≠„Ç∞„Éï„Ç°„Ç§„É´„ÅØÁ©∫„Åß„Åô„ÄÇ\n„Éë„Çπ: \(url.path)"
                        showLogAlert = true
                    } else {
                        logFileURL = url
                        showShareSheet = true
                        logAlertMessage = "„É≠„Ç∞„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫: \(contents.count) „Éê„Ç§„Éà"
                        print("üìù SettingsView: Log file size: \(contents.count) bytes")
                    }
                } else {
                    logAlertMessage = "„É≠„Ç∞„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„ÄÇ\n„Éë„Çπ: \(url.path)"
                    showLogAlert = true
                }
            } else {
                logAlertMessage = "„É≠„Ç∞„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ\nÊúüÂæÖ„Åï„Çå„Çã„Éë„Çπ: \(url.path)\n\n„Ç¢„Éó„É™„ÇíÂÜçËµ∑Âãï„Åó„Å¶„Åã„Çâ„ÄÅ‰Ωï„ÅãÊìç‰Ωú„ÇíË°å„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                showLogAlert = true
            }
        } else {
            logAlertMessage = "„É≠„Ç∞„Éï„Ç°„Ç§„É´„ÅÆURL„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„ÄÇ"
            showLogAlert = true
        }
    }

    private func clearLogs() {
        FileLogger.shared.clearLogs()
        logAlertMessage = "„É≠„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ"
        showLogAlert = true
    }

    private func loadProfileImage() {
        if let imageData = UserDefaults.standard.data(forKey: "profileImage"),
           let image = UIImage(data: imageData) {
            profileImage = image
            print("‚úÖ SettingsView: Loaded profile image from UserDefaults")
        }
    }

    private func saveProfileImage(_ image: UIImage) {
        // Save locally first for immediate display
        if let imageData = image.jpegData(compressionQuality: 0.8) {
            UserDefaults.standard.set(imageData, forKey: "profileImage")
            print("‚úÖ SettingsView: Saved profile image to UserDefaults")
        }

        // Upload to server
        Task {
            do {
                let imageUrl = try await APIService.shared.uploadImage(image)
                print("‚úÖ SettingsView: Uploaded image to server: \(imageUrl)")

                let updatedUser = try await APIService.shared.updateProfileImage(imageUrl)
                print("‚úÖ SettingsView: Updated profile with image URL")

                await MainActor.run {
                    authService.currentUser = updatedUser
                }
            } catch {
                print("‚ùå SettingsView: Failed to upload profile image: \(error)")
            }
        }
    }
}

// ProfileImagePicker for selecting profile images
struct ProfileImagePicker: UIViewControllerRepresentable {
    @Binding var selectedImage: UIImage?
    @Environment(\.presentationMode) var presentationMode

    func makeUIViewController(context: Context) -> UIImagePickerController {
        let picker = UIImagePickerController()
        picker.delegate = context.coordinator
        picker.sourceType = .photoLibrary
        picker.allowsEditing = true
        return picker
    }

    func updateUIViewController(_ uiViewController: UIImagePickerController, context: Context) {}

    func makeCoordinator() -> Coordinator {
        Coordinator(self)
    }

    class Coordinator: NSObject, UIImagePickerControllerDelegate, UINavigationControllerDelegate {
        let parent: ProfileImagePicker

        init(_ parent: ProfileImagePicker) {
            self.parent = parent
        }

        func imagePickerController(_ picker: UIImagePickerController, didFinishPickingMediaWithInfo info: [UIImagePickerController.InfoKey : Any]) {
            if let editedImage = info[.editedImage] as? UIImage {
                parent.selectedImage = editedImage
            } else if let originalImage = info[.originalImage] as? UIImage {
                parent.selectedImage = originalImage
            }
            parent.presentationMode.wrappedValue.dismiss()
        }

        func imagePickerControllerDidCancel(_ picker: UIImagePickerController) {
            parent.presentationMode.wrappedValue.dismiss()
        }
    }
}

// ActivityViewController for sharing files
struct ActivityViewController: UIViewControllerRepresentable {
    let activityItems: [Any]

    func makeUIViewController(context: Context) -> UIActivityViewController {
        UIActivityViewController(activityItems: activityItems, applicationActivities: nil)
    }

    func updateUIViewController(_ uiViewController: UIActivityViewController, context: Context) {}
}

#Preview {
    SettingsView()
}
