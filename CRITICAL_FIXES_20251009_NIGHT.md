# 重大修正（2025年10月9日 夜）

**作成日時**: 2025年10月9日 22:00
**ステータス**: ✅ 修正完了 → 再ビルド必須

---

## 報告された問題

1. **メッセージ通知**: アプリ画面上でないと通知が来ない。音とバイブのみ。
2. **ビデオ通話**: ビデオ通話で立ち上がらない
3. **画面オフ時の着信**: スマホが暗い状態（画面オフ）でも着信できるようにしたい

---

## 修正内容

### 修正1: isVideoCallが上書きされる問題

**問題**:
ContentView.swiftでCallKitから受け取った`hasVideo`フラグを`callManager.isVideoCall`に設定していましたが、その後`acceptIncomingCall()`内で`detectVideoFromSDP()`が再度実行され、設定が上書きされていました。

**修正内容**:

#### CallManager.swift (Line 361-369)

```swift
// isVideoCallが既に設定されている場合（CallKitから）はそれを優先
// 未設定の場合のみSDPから判別
if self.callUUID == nil {
    let hasVideo = detectVideoFromSDP(offer)
    self.isVideoCall = hasVideo
    print("🔵 CallManager: Call type from SDP: \(hasVideo ? "ビデオ通話" : "音声通話")")
} else {
    print("🔵 CallManager: Using CallKit video flag: \(self.isVideoCall ? "ビデオ通話" : "音声通話")")
}
```

**判別ロジック**:
- `callUUID != nil` → CallKit経由の着信 → ContentViewで設定された`isVideoCall`を維持
- `callUUID == nil` → 通常の着信（アプリ起動中） → SDPから判別

**効果**:
- ✅ VoIP Push経由の着信でビデオフラグが正しく設定される
- ✅ ビデオ通話がビデオ通話として起動する
- ✅ アプリ起動中の着信も正しく動作する

---

## メッセージ通知の問題（要確認）

### 現状

**報告**: 音とバイブのみ。バナーが表示されない。

### 調査結果

1. **サーバー側の設定**:
   - APNs環境: `sandbox` ✅
   - APNsキーファイル: 存在 ✅
   - 通知ペイロード: 正しく設定されている ✅

2. **iOS側の実装**:
   - UIBackgroundModes: `remote-notification`含まれる ✅
   - NotificationsService: 正しく実装されている ✅
   - AppDelegate: APNsトークン登録処理あり ✅

3. **「音とバイブのみ」の意味**:
   - 通知は届いている（APNsが動作している）
   - しかし、バナーが表示されていない

### 確認が必要な項目

#### 1. iOSの通知設定を確認 ⭐ 最重要

```
設定 → ChuTalk → 通知
```

**以下をすべてONにしてください**:
- ✅ **通知を許可**: ON
- ✅ **ロック画面**: ON
- ✅ **通知センター**: ON
- ✅ **バナー**: ON ← これが一番重要！
- ✅ **バナースタイル**: 一時的 または 持続的
- ✅ **サウンド**: ON
- ✅ **バッジ**: ON

**現在の設定を確認してください**。特に「バナー」がOFFになっていないか確認してください。

#### 2. アプリ起動時のログを確認

アプリを起動した直後、Xcodeのコンソールに以下のようなログが表示されますか？

```
📱 NotificationsService: Authorization status: 2
   Alert: 2
   Badge: 2
   Sound: 2
```

**すべて `2` (Authorized)である必要があります。**

もし `0` または `1` の場合、通知権限が許可されていません。

**対処法**:
1. アプリをアンインストール
2. iPhoneを再起動
3. アプリを再インストール
4. 通知権限を許可する

#### 3. メッセージ送信テスト

**手順**:
1. ユーザー10のアプリを完全に停止（タスクマネージャーからスワイプアップ）
2. 30秒待つ
3. ユーザー11がユーザー10にメッセージ「テスト」を送信
4. **ユーザー10のデバイスで通知が表示されるか確認**

**期待される動作**:
- ✅ 通知バナーが画面に表示される
- ✅ ロック画面にも表示される
- ✅ 通知音が鳴る
- ✅ バイブが振動する

**もし表示されない場合**:
→ iOSの通知設定で「バナー」がOFFになっている可能性が高い

---

## 画面オフ時の着信（既に実装済み）

### 現状

**報告**: スマホが暗い状態（画面オフ）でも着信できるようにしたい

### 確認結果

**画面オフ時の着信機能は既に正しく実装されています**:

1. **VoIP Push**: バックグラウンド・画面オフ時でもアプリを起動 ✅
2. **CallKit**: 画面オフ時でも着信画面を表示 ✅
3. **UIBackgroundModes**: `voip`が含まれる ✅

### 動作の仕組み

**画面オフ時の着信フロー**:
1. ユーザー11がユーザー10に発信
2. Signal ServerがVoIP Pushを送信（APNs経由）
3. iOSがユーザー10のアプリを起動（画面がオフでも）
4. VoIPPushService.swiftがVoIP Pushを受信
5. CallKitProvider.swiftが着信画面を表示（画面が自動的にオンになる）
6. ユーザー10が応答ボタンをタップ
7. ビデオ通話が確立

### テスト手順

**1. アプリを再ビルド（必須）**
```
Xcode:
Product → Clean Build Folder (Shift + Cmd + K)
Product → Build (Cmd + B)
Product → Run (Cmd + R)
```

**2. 画面オフ時の着信をテスト**

**手順**:
1. ユーザー10のアプリを完全に停止（タスクマネージャーからスワイプアップ）
2. ユーザー10のiPhoneの画面をオフにする（電源ボタンを押す）
3. 30秒待つ
4. ユーザー11がユーザー10にビデオ通話で発信
5. **ユーザー10のiPhoneの画面が自動的にオンになり、CallKit着信画面が表示される**
6. 応答ボタンをタップ
7. ビデオ通話が確立することを確認

**期待される動作**:
- ✅ 画面が自動的にオンになる
- ✅ CallKit着信画面が表示される（「〇〇さんからビデオ通話」）
- ✅ 応答ボタンと拒否ボタンが表示される
- ✅ 応答後、ビデオ通話が確立する

**もし着信画面が表示されない場合**:

**原因1: アプリが再ビルドされていない**
→ 修正をビルドしてインストールしてください

**原因2: VoIP Pushトークンが登録されていない**
→ アプリ起動時のログで以下を確認:
```
✅ VoIPPushService: VoIP Token: [トークン]
✅ NotificationsService: Device tokens uploaded successfully
```

**原因3: サーバー側でVoIP Pushの送信に失敗している**
→ サーバーログを確認:
```bash
docker logs -f chutalk_signal | grep "VoIP Push"
```

期待されるログ:
```
✅ VoIP Push sent to user 10
```

---

## まとめ

### 実施した修正

1. ✅ **CallManager.swift**: isVideoCallの上書き問題を修正
   - CallKit経由の着信では、CallKitから受け取ったhasVideoフラグを優先
   - 通常の着信では、SDPから判別

### 確認が必要な項目

1. ⭐ **iOSの通知設定**: 「バナー」がONになっているか確認
   - 設定 → ChuTalk → 通知 → バナー: ON

2. ⭐ **通知権限**: アプリ起動時のログで確認
   - すべて `2` (Authorized)である必要がある

3. ⭐ **画面オフ時の着信**: アプリを再ビルドしてテスト
   - 画面オフ時に発信してテスト

### 期待される効果

1. ✅ **ビデオ通話**: VoIP Push経由の着信でビデオ通話として起動する
2. ⚠️ **メッセージ通知**: iOSの通知設定を確認する必要がある
3. ✅ **画面オフ時の着信**: 既に実装済み、再ビルドでテスト

---

## 次のステップ

### 1. アプリを再ビルド（必須）

```
Xcode:
Product → Clean Build Folder (Shift + Cmd + K)
Product → Build (Cmd + B)
Product → Run (Cmd + R)
```

### 2. iOSの通知設定を確認

```
設定 → ChuTalk → 通知
```

すべての項目がONになっているか確認してください。特に「バナー」。

### 3. テストを実行

**テスト1: ビデオ通話（画面オフ時）**
1. ユーザー10のアプリを停止 → 画面をオフ
2. 30秒待つ
3. ユーザー11から発信
4. 画面が自動的にオンになり、CallKit着信画面が表示されるか確認
5. 応答してビデオ通話が確立するか確認

**テスト2: メッセージ通知（アプリ停止時）**
1. ユーザー10のアプリを停止
2. 30秒待つ
3. ユーザー11からメッセージ送信
4. 通知バナーが表示されるか確認（音とバイブだけでなく）

### 4. 結果を報告

以下の情報を報告してください：

1. **iOSの通知設定**:
   - 通知を許可: ON/OFF?
   - バナー: ON/OFF?
   - サウンド: ON/OFF?

2. **アプリ起動時のログ**:
   ```
   📱 NotificationsService: Authorization status: ?
      Alert: ?
      Badge: ?
      Sound: ?
   ```

3. **テスト1の結果**:
   - 画面が自動的にオンになったか？
   - CallKit着信画面が表示されたか？
   - ビデオ通話が確立したか？

4. **テスト2の結果**:
   - 通知バナーが表示されたか？
   - または音とバイブのみか？

---

**最終更新**: 2025年10月9日 22:00
**次回アクション**:
1. アプリを再ビルド
2. iOSの通知設定を確認
3. テストを実行
4. 結果を報告
