# 通知問題の診断手順

**作成日時**: 2025年10月9日 22:30

---

## 報告された問題

**症状**: メッセージ通知が音とバイブのみで、バナーが表示されない

---

## 調査結果

### 1. サーバー側の設定

✅ **APNs環境**: `sandbox`
✅ **APNsキーファイル**: 存在（/certs/AuthKey_VLC43VS8N5.p8）
✅ **通知ペイロード**: 正しく設定されている
```javascript
notification.alert = { title, body };  // バナー表示に必要
notification.sound = 'default';         // 音
notification.badge = 1;                 // バッジ
```

### 2. iOS側の設定

✅ **Entitlements**: `aps-environment: development` → sandboxと一致
✅ **Info.plist**: `UIBackgroundModes: remote-notification` → 設定済み
✅ **NotificationsService**: デリゲート実装済み
✅ **通知権限**: リクエスト処理あり

---

## 問題の原因

「音とバイブのみ」ということは、**通知は届いているが、バナーが表示されていない**状態です。

### 最も可能性が高い原因

**iOSの通知設定で「バナー」がOFFになっている**

iOSでは、通知の表示方法を個別に設定できます：
- ✅ **サウンド**: ON → 音が鳴る
- ✅ **バイブ**: （システム設定に従う） → 振動する
- ❌ **バナー**: OFF → バナーが表示されない

---

## 診断テスト

以下の手順で問題を特定してください：

### テスト1: iOSの通知設定を確認 ⭐ 最重要

**手順**:
```
iPhoneの設定アプリを開く
↓
下にスクロールして「ChuTalk」を探す
↓
「通知」をタップ
↓
以下の項目を確認
```

**確認項目**:
- [ ] **通知を許可**: ON になっているか？
- [ ] **ロック画面**: ON になっているか？
- [ ] **通知センター**: ON になっているか？
- [ ] **バナー**: ON になっているか？ ← これが最重要！
- [ ] **バナースタイル**: 「一時的」または「持続的」が選ばれているか？
- [ ] **サウンド**: ON になっているか？
- [ ] **バッジ**: ON になっているか？

**もし「バナー」がOFFになっていたら**:
→ これが原因です！ONにしてください。

**もしすべてONになっているのにバナーが表示されない場合**:
→ テスト2に進んでください。

---

### テスト2: アプリ起動時の通知権限を確認

**手順**:
1. Xcodeでアプリをビルド・起動
2. 起動直後のコンソールログを確認

**確認するログ**:
```
📱 NotificationsService: Authorization status: ?
   Alert: ?
   Badge: ?
   Sound: ?
```

**期待される値**:
```
📱 NotificationsService: Authorization status: 2
   Alert: 2
   Badge: 2
   Sound: 2
```

すべて `2` (Authorized)である必要があります。

**もし `0` または `1` の場合**:
→ 通知権限が完全に許可されていません。

**対処法**:
1. アプリをアンインストール
2. iPhoneを再起動
3. アプリを再インストール
4. 通知権限を許可する

---

### テスト3: メッセージ送信テスト（完全版）

このテストで、どのタイミングで通知が表示されるかを確認します。

#### 3-1: フォアグラウンドテスト

**手順**:
1. 両デバイスでアプリを起動
2. ユーザー10がホーム画面にいる（チャット画面ではない）
3. ユーザー11からメッセージ「テスト1」を送信

**期待される動作**:
- ✅ カスタム通知バナー（青い背景）が画面上部に表示される
- ✅ 音が鳴る

**結果**:
- [ ] カスタムバナーが表示された
- [ ] 音が鳴った

#### 3-2: バックグラウンドテスト

**手順**:
1. ユーザー10でアプリを起動
2. ホームボタン（またはスワイプアップ）でバックグラウンドに移動（アプリは終了しない）
3. ユーザー11からメッセージ「テスト2」を送信

**期待される動作**:
- ✅ iOS標準の通知バナーが画面上部に表示される
- ✅ 音が鳴る
- ✅ バイブが振動する

**結果**:
- [ ] バナーが表示された
- [ ] 音が鳴った
- [ ] バイブが振動した

**もし音だけで、バナーが表示されない場合**:
→ iOSの通知設定で「バナー」がOFFになっています

#### 3-3: 完全停止テスト

**手順**:
1. ユーザー10のアプリを完全に停止（タスクマネージャーからスワイプアップ）
2. 30秒待つ
3. ユーザー11からメッセージ「テスト3」を送信

**期待される動作**:
- ✅ iOS標準の通知バナーが表示される
- ✅ 音が鳴る
- ✅ バイブが振動する
- ✅ ロック画面にも表示される

**結果**:
- [ ] バナーが表示された
- [ ] 音が鳴った
- [ ] バイブが振動した
- [ ] ロック画面に表示された

**もし音だけで、バナーが表示されない場合**:
→ iOSの通知設定で「バナー」がOFFになっています

---

### テスト4: サーバーログの確認

アプリ停止時のメッセージ送信で、サーバー側のログを確認します。

**手順**:
1. ユーザー10のアプリを完全に停止
2. サーバーでログ監視を開始:
```bash
ssh takaoka@192.168.200.50
docker logs -f chutalk_signal | grep -A 5 "message"
```
3. ユーザー11からメッセージ送信

**期待されるログ**:
```
[signal] user 10 is offline, sending message push
📨 Sending message Push to user 10
✅ Message Push sent to user 10
```

**API Serverのログも確認**:
```bash
docker logs -f chutalk_api | grep -A 10 "sendMessagePush"
```

**期待されるログ**:
```
📤 sendMessagePush: Sending to user 10
   Title: [ユーザー11の表示名]
   Body: テスト3
📤 sendMessagePush: Sending to token 520d884ea5a55a28...
✅ sendMessagePush: Sent successfully
```

**もし「Sent successfully」が表示されない場合**:
```
❌ sendMessagePush: Failed: ...
```

→ サーバーログに表示されるエラーメッセージを確認してください

---

## 診断フローチャート

```
通知が来ない
    ↓
音とバイブはある？
    ↓ YES
    ├─→ iOSの通知設定「バナー」を確認 → OFFならONにする
    ↓ NO（何も来ない）
    ├─→ アプリ起動時のログを確認
        ├─→ Authorization status が 2 か？
            ├─→ YES: サーバーログを確認
            └─→ NO: 通知権限を再度許可（アプリ再インストール）
```

---

## よくある誤解

### 誤解1: 「音とバイブが来るから通知は正常」

❌ **間違い**: 音とバイブだけでは不十分です。バナーも表示されるべきです。

✅ **正しい**: 音・バイブ・バナーの3つすべてが表示されるのが正常な動作です。

### 誤解2: 「アプリ内で通知が来るから設定は正常」

❌ **間違い**: アプリ内のカスタム通知は、別の仕組み（NotificationServiceのポーリング）で表示されています。

✅ **正しい**: アプリ停止時の通知は、APNs経由でiOSが表示します。これは別の設定が必要です。

### 誤解3: 「前は動いていたから設定は変わっていない」

❌ **間違い**: iOSのアップデートや、アプリの再インストール時に通知設定がリセットされることがあります。

✅ **正しい**: 毎回、iOSの通知設定を確認してください。

---

## チェックリスト

以下の項目をすべて確認してください：

### iOS側の設定
- [ ] 設定 → ChuTalk → 通知 → 通知を許可: ON
- [ ] 設定 → ChuTalk → 通知 → ロック画面: ON
- [ ] 設定 → ChuTalk → 通知 → 通知センター: ON
- [ ] 設定 → ChuTalk → 通知 → バナー: ON ⭐
- [ ] 設定 → ChuTalk → 通知 → バナースタイル: 一時的または持続的
- [ ] 設定 → ChuTalk → 通知 → サウンド: ON
- [ ] 設定 → ChuTalk → 通知 → バッジ: ON

### アプリ側の確認
- [ ] アプリ起動時のログで Authorization status が 2
- [ ] アプリ起動時のログで Alert が 2
- [ ] アプリ起動時のログで Badge が 2
- [ ] アプリ起動時のログで Sound が 2

### サーバー側の確認
- [ ] サーバーログで「Sent successfully」が表示される
- [ ] APNsトークンがDBに登録されている

---

## 結論

**99%の確率で、iOSの通知設定で「バナー」がOFFになっています。**

まず、以下を確認してください：
```
設定 → ChuTalk → 通知 → バナー: ON
```

これをONにすれば、バナーが表示されるはずです。

---

**最終更新**: 2025年10月9日 22:30
