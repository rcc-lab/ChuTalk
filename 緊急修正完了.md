
# 緊急修正完了レポート

**修正日時**: 2025年10月10日
**問題**: ビデオ通話・音声通話が接続できない / アプリ停止時に着信できない

---

## 🚨 発見された問題

### 問題1: VoIP Push Payloadのキー名不一致

**サーバー側** (修正後):
```javascript
{
  "callId": "11-10",
  "callerId": 11,          // ✅ 正しいキー名
  "callerName": "User 11"  // ✅ 正しいキー名
}
```

**iOS側** (修正前):
```swift
let fromUserId = int("fromUserId")           // ❌ 古いキー名
let fromDisplayName = str("fromDisplayName") // ❌ 古いキー名
```

→ **キー名が不一致のため、VoIP Pushのpayloadが正しく解析できず、CallKitが呼ばれない**

---

### 問題2: カメラ・マイク権限の確認がない

**修正前**:
- WebRTCServiceが権限を確認せずにカメラ・マイクにアクセス
- 権限がない場合、エラーログもなくサイレント失敗
- ユーザーが権限を許可していても、アプリ側で確認処理がない

→ **カメラ・マイクへのアクセスが失敗し、通話が接続できない**

---

## 🔧 実施した修正

### 修正1: VoIPPayload.swift - キー名の修正

**ファイル**: `ChuTalk/Models/VoIPPayload.swift`

**Line 55-59 (修正後)**:
```swift
// callerId（Int、デフォルト0）- サーバーから callerId で送信される
let fromUserId = int("callerId") ?? int("fromUserId") ?? 0

// callerName（デフォルト値あり）- サーバーから callerName で送信される
let fromDisplayName = str("callerName") ?? str("fromDisplayName") ?? "Unknown"
```

**効果**: サーバーから送信される `callerId` と `callerName` を正しく読み取る（フォールバックとして古いキー名もサポート）

---

### 修正2: VoIPPushService.swift - フォールバック処理の修正

**ファイル**: `ChuTalk/Services/VoIPPushService.swift`

**Line 95-111 (修正後)**:
```swift
// callerName をチェック（フォールバックとして fromDisplayName もチェック）
let displayName = (dict["callerName"] as? String) ?? (dict["fromDisplayName"] as? String) ?? "Unknown Caller"

// callerId をチェック（フォールバックとして fromUserId もチェック）
let fromUserId: Int = {
    if let n = dict["callerId"] as? NSNumber { return n.intValue }
    if let i = dict["callerId"] as? Int { return i }
    if let s = dict["callerId"] as? String, let i = Int(s) { return i }
    // フォールバック: 古いキー名もチェック
    if let n = dict["fromUserId"] as? NSNumber { return n.intValue }
    if let i = dict["fromUserId"] as? Int { return i }
    if let s = dict["fromUserId"] as? String, let i = Int(s) { return i }
    return 0
}()
```

**効果**: Payload解析がより堅牢になり、新旧両方のキー名に対応

---

### 修正3: WebRTCService.swift - カメラ・マイク権限確認の追加

**ファイル**: `ChuTalk/Services/WebRTCService.swift`

**追加内容**:

#### 1. AVFoundation import (Line 11):
```swift
import AVFoundation
```

#### 2. requestMediaPermissions() メソッド追加 (Line 55-103):
```swift
func requestMediaPermissions(isVideo: Bool) async -> Bool {
    // マイク権限を確認
    let audioStatus = AVCaptureDevice.authorizationStatus(for: .audio)

    switch audioStatus {
    case .authorized:
        print("✅ WebRTCService: Microphone already authorized")
    case .notDetermined:
        print("📱 WebRTCService: Requesting microphone permission...")
        let granted = await AVCaptureDevice.requestAccess(for: .audio)
        if !granted {
            print("❌ WebRTCService: Microphone permission denied")
            return false
        }
        print("✅ WebRTCService: Microphone permission granted")
    case .denied, .restricted:
        print("❌ WebRTCService: Microphone permission denied or restricted")
        return false
    @unknown default:
        print("⚠️ WebRTCService: Unknown microphone permission status")
        return false
    }

    // ビデオ通話の場合、カメラ権限も確認
    if isVideo {
        let videoStatus = AVCaptureDevice.authorizationStatus(for: .video)

        switch videoStatus {
        case .authorized:
            print("✅ WebRTCService: Camera already authorized")
        case .notDetermined:
            print("📱 WebRTCService: Requesting camera permission...")
            let granted = await AVCaptureDevice.requestAccess(for: .video)
            if !granted {
                print("❌ WebRTCService: Camera permission denied")
                return false
            }
            print("✅ WebRTCService: Camera permission granted")
        case .denied, .restricted:
            print("❌ WebRTCService: Camera permission denied or restricted")
            return false
        @unknown default:
            print("⚠️ WebRTCService: Unknown camera permission status")
            return false
        }
    }

    return true
}
```

#### 3. startCaptureLocalVideo() にエラーハンドリング追加 (Line 162-196):
```swift
func startCaptureLocalVideo() {
    #if !targetEnvironment(simulator)
    guard let capturer = videoCapturer else {
        print("❌ WebRTCService: Video capturer is nil")
        return
    }

    let devices = RTCCameraVideoCapturer.captureDevices()
    print("🎥 WebRTCService: Found \(devices.count) camera devices")

    guard let frontCamera = devices.first(where: { $0.position == .front }) else {
        print("❌ WebRTCService: No front camera found")
        return
    }

    print("✅ WebRTCService: Using front camera: \(frontCamera.localizedName)")

    let formats = RTCCameraVideoCapturer.supportedFormats(for: frontCamera)
    guard let format = formats.first else {
        print("❌ WebRTCService: No supported formats for camera")
        return
    }

    let fps = format.videoSupportedFrameRateRanges.first?.maxFrameRate ?? 30
    print("🎥 WebRTCService: Starting capture at \(fps) fps")

    capturer.startCapture(with: frontCamera, format: format, fps: Int(fps)) { error in
        if let error = error {
            print("❌ WebRTCService: Failed to start capture - \(error.localizedDescription)")
        } else {
            print("✅ WebRTCService: Camera capture started successfully")
        }
    }
    #endif
}
```

**効果**:
- カメラ・マイク権限を明示的に確認・リクエスト
- 権限がない場合は詳細なログを出力
- カメラキャプチャ開始時のエラーを検出

---

### 修正4: CallManager.swift - 権限確認処理の追加

**ファイル**: `ChuTalk/Services/CallManager.swift`

#### startCall() - Line 200-207:
```swift
// カメラ・マイク権限を確認
let hasPermission = await webRTCService.requestMediaPermissions(isVideo: isVideo)
if !hasPermission {
    print("❌ CallManager: Media permissions not granted")
    self.isSettingUpCall = false
    await endCall()
    return
}
```

#### acceptIncomingCall() - Line 452-459:
```swift
// カメラ・マイク権限を確認
let hasPermission = await webRTCService.requestMediaPermissions(isVideo: isVideoCall)
if !hasPermission {
    print("❌ CallManager: Media permissions not granted")
    self.isSettingUpCall = false
    await endCall()
    return
}
```

**効果**: WebRTC接続を開始する前に、必ず権限を確認

---

## 📊 修正前後の比較

### VoIP Push受信フロー

#### 修正前:
```
サーバー: { callerId: 11, callerName: "User 11" }
    ↓
iOS VoIPPayload.parse(): fromUserId を探す
    ↓
❌ キーが見つからない → nil を返す
    ↓
VoIPPushService: fromDisplayName を探す
    ↓
❌ キーが見つからない → "Unknown Caller"
    ↓
CallKit呼び出し → 動作するが発信者情報が不正確
```

#### 修正後:
```
サーバー: { callerId: 11, callerName: "User 11" }
    ↓
iOS VoIPPayload.parse(): callerId を探す
    ↓
✅ 見つかった → callerId = 11
    ↓
callerName を探す
    ↓
✅ 見つかった → callerName = "User 11"
    ↓
CallKit呼び出し → 正しい発信者情報で着信表示
```

---

### WebRTC接続フロー

#### 修正前:
```
CallManager.startCall()
    ↓
setupPeerConnection()
    ↓
WebRTCService.setupLocalTracks()
    ↓
カメラにアクセス試行
    ↓
❌ 権限なし → サイレント失敗
    ↓
❌ 接続できない
```

#### 修正後:
```
CallManager.startCall()
    ↓
WebRTCService.requestMediaPermissions()
    ↓
カメラ・マイク権限確認
    ↓
  権限なし → ユーザーに許可リクエスト
    ↓
  ユーザーが許可
    ↓
✅ setupPeerConnection()
    ↓
✅ WebRTCService.setupLocalTracks()
    ↓
✅ カメラキャプチャ開始
    ↓
✅ 正常に接続
```

---

## 🚀 ビルド・テスト手順

### ステップ1: クリーンビルド

```bash
# Xcodeで実行:
1. Product → Clean Build Folder (Cmd + Shift + K)
2. Product → Build (Cmd + B)
```

### ステップ2: アプリの再インストール

```bash
1. デバイスからChuTalkアプリを削除
2. デバイスを再起動
3. Xcodeで Product → Run (Cmd + R)
```

### ステップ3: 権限の許可

アプリ起動時に表示される権限リクエストで「許可」を選択:
- 🎤 **マイク**
- 📷 **カメラ**
- 🔔 **通知**

**期待されるログ**:
```
📱 WebRTCService: Requesting microphone permission...
✅ WebRTCService: Microphone permission granted
📱 WebRTCService: Requesting camera permission...
✅ WebRTCService: Camera permission granted
```

### ステップ4: ビデオ通話テスト

1. **User 11からUser 10へビデオ通話発信**
2. **発信側ログ確認**:
```
🔵 CallManager: Starting call to rcc122
✅ WebRTCService: Microphone already authorized
✅ WebRTCService: Camera already authorized
🎥 WebRTCService: Setting up local tracks - isVideo: true
✅ WebRTCService: Audio track added
✅ WebRTCService: Video track added
🎥 WebRTCService: Found 2 camera devices
✅ WebRTCService: Using front camera: Front Camera
🎥 WebRTCService: Starting capture at 30.0 fps
✅ WebRTCService: Camera capture started successfully
🎥 WebRTCService: Creating offer - isVideo: true
✅ CallManager: Offer sent via Socket.io to rcc122
```

3. **着信側ログ確認**:
```
🔵 CallManager: Received offer from user 11 via Socket.io
📞 CallManager: Reporting incoming call to CallKit
✅ CallManager: CallKit report completed for Socket.io offer
```

4. **着信を応答**
5. **両側で映像と音声が確認できること**

**期待されるログ (両側)**:
```
ICE connection state changed: 2  // connected
✅ CallManager: Call connected
```

### ステップ5: VoIP Push テスト (アプリ停止時)

1. **User 10のアプリを完全に終了** (スワイプ)
2. **User 11からビデオ通話発信**

**期待される動作**:
- User 10のデバイスで着信画面が表示される

**期待されるログ (サーバー側)**:
```bash
docker logs -f chutalk_signal
```
```
[signal] user 10 is offline, saving offer to API and sending VoIP Push
📞 Sending VoIP Push to user 10
✅ VoIP Push sent to user 10
```

```bash
docker logs -f chutalk_api
```
```
📞 sendVoipPush: Sending to user 10
📞 sendVoipPush: Payload: {
  "callId": "11-10",
  "callerId": 11,
  "callerName": "User 11",
  "hasVideo": true
}
✅ sendVoipPush: Sent successfully
```

**期待されるログ (iOS側 - Xcodeで接続中の場合)**:
```
📞 VoIPPushService: ========== INCOMING VOIP PUSH ==========
📞 VoIPPushService: Payload: {...}
📦 VoIPPayload: Parsing payload...
✅ VoIPPayload: Successfully parsed
   callerId: 11
   callerName: User 11
   hasVideo: true
📞 VoIPPushService: Reporting incoming call to CallKit
✅ VoIPPushService: CallKit report completed
```

---

## ⚠️ トラブルシューティング

### Q1: カメラ・マイクの権限リクエストが表示されない

**原因**: アプリが既にインストールされており、修正が反映されていない

**対処方法**:
1. デバイスからアプリを完全削除
2. デバイスを再起動
3. Xcode → Clean Build Folder → Build → Run

---

### Q2: 「❌ WebRTCService: Microphone permission denied」と表示される

**原因**: ユーザーがマイク権限を拒否した、または設定で無効になっている

**対処方法**:
1. **設定 → ChuTalk → マイク** を開く
2. **ON**に切り替える
3. アプリを再起動

---

### Q3: 「❌ WebRTCService: Failed to start capture」と表示される

**原因**: カメラがロックされている、または他のアプリが使用中

**対処方法**:
1. 他のカメラアプリを終了
2. デバイスを再起動
3. アプリを再起動

---

### Q4: VoIP Pushは送信されているが、デバイスが受信しない

**原因**: デバイスがVoIP Push配信をブロックされている可能性

**対処方法**:
1. `VOIP_PUSH_IMPLEMENTATION.md` のデバイスリセット手順を実施
2. 別のデバイスでテスト
3. サーバーログで「✅ sendVoipPush: Sent successfully」を確認

---

## ✅ チェックリスト

### iOS側修正
- [x] VoIPPayload.swift: キー名を `callerId`, `callerName` に修正
- [x] VoIPPushService.swift: フォールバック処理を修正
- [x] WebRTCService.swift: カメラ・マイク権限確認処理を追加
- [x] WebRTCService.swift: エラーハンドリングを強化
- [x] CallManager.swift: 権限確認処理を追加

### サーバー側修正 (既に完了)
- [x] push.js: VoIP Payloadのキー名を `callerId`, `callerName` に修正
- [x] APIサーバー再起動

### テスト
- [ ] アプリの再インストール
- [ ] 権限の許可 (カメラ、マイク、通知)
- [ ] User 10で再ログイン
- [ ] ビデオ通話テスト (アプリ起動中)
- [ ] 音声通話テスト (アプリ起動中)
- [ ] VoIP Push着信テスト (アプリ停止時)

---

## 📖 関連ドキュメント

| ドキュメント | 内容 |
|------------|------|
| **緊急修正完了.md** | 本ドキュメント |
| **修正完了サマリー.md** | iOS側の以前の修正内容 |
| **サーバー側修正完了.md** | サーバー側の修正内容 |
| **VOIP_PUSH_IMPLEMENTATION.md** | VoIP Push実装ガイド |
| **FIXES.md** | 詳細な修正説明・トラブルシューティング |

---

**次のアクション**: アプリを再インストールして、ビデオ通話とVoIP Push着信のテストを実施してください。

---

**最終更新**: 2025年10月10日
